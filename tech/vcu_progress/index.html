<!doctype html><html><head lang=en><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><title>VCU é–‹ç™¼é€²åº¦ç¸½çµ â€” 2025-08-01 - Hank Tech Lab</title><meta name=viewport content="width=device-width,initial-scale=1">
<meta name=description content="æ›´æ–°æ¦‚è¦ï¼ˆ2025-07-30ï¼‰ å·²ç¢ºèª Allegro encoder callback æ©Ÿåˆ¶æœƒå¡ä½æ˜¯å› ç‚ºæœªåœ¨ callback ä¸­å‘¼å« AL_Encoder_PutStreamBuffer() æ­¸é‚„ä½¿ç”¨éçš„ bitstream bufferã€‚æ­¤è¡Œç‚ºé•åä¸€èˆ¬ callback ä½¿ç”¨å¸¸è­˜ï¼Œä½†ç¢ºå¯¦ç‚ºå¿…è¦æ“ä½œï¼Œå¦å‰‡ encoder å°‡ç„¡æ³•ç¹¼çºŒç”¢å‡º ESã€‚
Send Input Frame Traceï¼ˆ2025-08-01ï¼‰ exe_encoder ä¸»é‚è¼¯åœ¨ SafeChannelMain() è£¡ï¼š
while (...) { LayerResources::SendInput(...); } ğŸ” Function Call Trace SafeChannelMain() â””â”€ LayerResources::SendInput(cfg, enc.get(), traceHooker) â””â”€ sendInputFileTo( frameReader, SrcBufPool, SrcYuv.get(), cfg, FileInfo, pSrcConv.get(), firstSink, iPictCount, iReadCount ) â””â”€ GetSrcFrame( iReadCount, iPictCount, frameReader, FileInfo, SrcBufPool, Yuv, tChParam, cfg, pSrcConv ) â””â”€ ReadSourceFrame(SrcBufPool, Yuv, frameReader, tUpdatedDim, pSrcConv) â””â”€ ReadSourceFrameBuffer(pBuffer, conversionBuffer, frameReader, tUpdatedDim, pSrcConv) â”œâ”€ if conversion needed: â”‚ â”œâ”€ frameReader->ReadFrame(conversionBuffer) â”‚ â””â”€ pSrcConv->ConvertSrcBuf(conversionBuffer, pBuffer) â””â”€ else: â””â”€ frameReader->ReadFrame(pBuffer) ğŸ§© Input Components èªªæ˜ è®Šæ•¸å é¡å‹ / ä¾†æº å‚™è¨» frameReader unique_ptr<FrameReader> Instance variableï¼ˆUnCompFrameReaderï¼‰ SrcBufPool PixMapBufPool DMA allocator buffer pool Yuv AL_TBuffer * ä½¿ç”¨ SrcYuv."><meta property="og:image" content><meta property="og:url" content="https://hanketgithub.github.io/tech/vcu_progress/"><meta property="og:site_name" content="Hank Tech Lab"><meta property="og:title" content="VCU é–‹ç™¼é€²åº¦ç¸½çµ â€” 2025-08-01"><meta property="og:description" content="æ›´æ–°æ¦‚è¦ï¼ˆ2025-07-30ï¼‰ å·²ç¢ºèª Allegro encoder callback æ©Ÿåˆ¶æœƒå¡ä½æ˜¯å› ç‚ºæœªåœ¨ callback ä¸­å‘¼å« AL_Encoder_PutStreamBuffer() æ­¸é‚„ä½¿ç”¨éçš„ bitstream bufferã€‚æ­¤è¡Œç‚ºé•åä¸€èˆ¬ callback ä½¿ç”¨å¸¸è­˜ï¼Œä½†ç¢ºå¯¦ç‚ºå¿…è¦æ“ä½œï¼Œå¦å‰‡ encoder å°‡ç„¡æ³•ç¹¼çºŒç”¢å‡º ESã€‚
Send Input Frame Traceï¼ˆ2025-08-01ï¼‰ exe_encoder ä¸»é‚è¼¯åœ¨ SafeChannelMain() è£¡ï¼š
while (...) { LayerResources::SendInput(...); } ğŸ” Function Call Trace SafeChannelMain() â””â”€ LayerResources::SendInput(cfg, enc.get(), traceHooker) â””â”€ sendInputFileTo( frameReader, SrcBufPool, SrcYuv.get(), cfg, FileInfo, pSrcConv.get(), firstSink, iPictCount, iReadCount ) â””â”€ GetSrcFrame( iReadCount, iPictCount, frameReader, FileInfo, SrcBufPool, Yuv, tChParam, cfg, pSrcConv ) â””â”€ ReadSourceFrame(SrcBufPool, Yuv, frameReader, tUpdatedDim, pSrcConv) â””â”€ ReadSourceFrameBuffer(pBuffer, conversionBuffer, frameReader, tUpdatedDim, pSrcConv) â”œâ”€ if conversion needed: â”‚ â”œâ”€ frameReader->ReadFrame(conversionBuffer) â”‚ â””â”€ pSrcConv->ConvertSrcBuf(conversionBuffer, pBuffer) â””â”€ else: â””â”€ frameReader->ReadFrame(pBuffer) ğŸ§© Input Components èªªæ˜ è®Šæ•¸å é¡å‹ / ä¾†æº å‚™è¨» frameReader unique_ptr<FrameReader> Instance variableï¼ˆUnCompFrameReaderï¼‰ SrcBufPool PixMapBufPool DMA allocator buffer pool Yuv AL_TBuffer * ä½¿ç”¨ SrcYuv."><meta property="og:locale" content="en-us"><meta property="og:type" content="article"><meta property="article:section" content="tech"><meta property="article:published_time" content="2025-07-01T00:00:00+00:00"><meta property="article:modified_time" content="2025-07-01T00:00:00+00:00"><meta property="article:tag" content="VCU"><meta name=twitter:card content="summary"><meta name=twitter:title content="VCU é–‹ç™¼é€²åº¦ç¸½çµ â€” 2025-08-01"><meta name=twitter:description content="æ›´æ–°æ¦‚è¦ï¼ˆ2025-07-30ï¼‰ å·²ç¢ºèª Allegro encoder callback æ©Ÿåˆ¶æœƒå¡ä½æ˜¯å› ç‚ºæœªåœ¨ callback ä¸­å‘¼å« AL_Encoder_PutStreamBuffer() æ­¸é‚„ä½¿ç”¨éçš„ bitstream bufferã€‚æ­¤è¡Œç‚ºé•åä¸€èˆ¬ callback ä½¿ç”¨å¸¸è­˜ï¼Œä½†ç¢ºå¯¦ç‚ºå¿…è¦æ“ä½œï¼Œå¦å‰‡ encoder å°‡ç„¡æ³•ç¹¼çºŒç”¢å‡º ESã€‚
Send Input Frame Traceï¼ˆ2025-08-01ï¼‰ exe_encoder ä¸»é‚è¼¯åœ¨ SafeChannelMain() è£¡ï¼š
while (...) { LayerResources::SendInput(...); } ğŸ” Function Call Trace SafeChannelMain() â””â”€ LayerResources::SendInput(cfg, enc.get(), traceHooker) â””â”€ sendInputFileTo( frameReader, SrcBufPool, SrcYuv.get(), cfg, FileInfo, pSrcConv.get(), firstSink, iPictCount, iReadCount ) â””â”€ GetSrcFrame( iReadCount, iPictCount, frameReader, FileInfo, SrcBufPool, Yuv, tChParam, cfg, pSrcConv ) â””â”€ ReadSourceFrame(SrcBufPool, Yuv, frameReader, tUpdatedDim, pSrcConv) â””â”€ ReadSourceFrameBuffer(pBuffer, conversionBuffer, frameReader, tUpdatedDim, pSrcConv) â”œâ”€ if conversion needed: â”‚ â”œâ”€ frameReader->ReadFrame(conversionBuffer) â”‚ â””â”€ pSrcConv->ConvertSrcBuf(conversionBuffer, pBuffer) â””â”€ else: â””â”€ frameReader->ReadFrame(pBuffer) ğŸ§© Input Components èªªæ˜ è®Šæ•¸å é¡å‹ / ä¾†æº å‚™è¨» frameReader unique_ptr<FrameReader> Instance variableï¼ˆUnCompFrameReaderï¼‰ SrcBufPool PixMapBufPool DMA allocator buffer pool Yuv AL_TBuffer * ä½¿ç”¨ SrcYuv."><link href=https://hanketgithub.github.io/css/fonts.2c2227b81b1970a03e760aa2e6121cd01f87c88586803cbb282aa224720a765f.css rel=stylesheet><link rel=stylesheet type=text/css media=screen href=https://hanketgithub.github.io/css/main.6a0f23ea50fd34b46fee262a5a68e17d458c51a2bc99ba1ba018065de6b180c3.css><link id=darkModeStyle rel=stylesheet type=text/css href=https://hanketgithub.github.io/css/dark.50b57e12d401420df23965fed157368aba37b76df0ecefd0b1ecd4da664f01a0.css disabled><style>@media print{body{font-family:pingfang tc,helvetica neue,sans-serif;font-size:12pt;line-height:1.6;color:#000}table,th,td{border:1px solid #666;border-collapse:collapse}th,td{padding:8px 12px;text-align:left}h1,h2{page-break-before:always}h1:first-of-type,h2:first-of-type{page-break-before:auto}img{max-width:100%;height:auto;page-break-inside:avoid}p{page-break-inside:avoid}a{color:#000;text-decoration:none}}</style></head><body><div class=content><header><div class=main><a href=https://hanketgithub.github.io/>Hank Tech Lab</a></div><nav><a href=/posts/>Posts</a>
| <span id=dark-mode-toggle onclick=toggleTheme()><svg class="feather"><use href="/svg/feather-sprite.51cf5647cb1987f769b616558f2620fd9423d72058490231b391bf6aa3744b55.svg#sun"/></svg></span>
<script src=https://hanketgithub.github.io/js/themetoggle.js></script></nav></header><main><article><div class=post-container><div class=post-content><div class=title><h1 class=title>VCU é–‹ç™¼é€²åº¦ç¸½çµ â€” 2025-08-01</h1><div class=meta>Posted on Jul 1, 2025</div></div><section class=body><h2 id=æ›´æ–°æ¦‚è¦2025-07-30>æ›´æ–°æ¦‚è¦ï¼ˆ2025-07-30ï¼‰</h2><p>å·²ç¢ºèª Allegro encoder callback æ©Ÿåˆ¶æœƒå¡ä½æ˜¯å› ç‚ºæœªåœ¨ callback ä¸­å‘¼å« <code>AL_Encoder_PutStreamBuffer()</code> æ­¸é‚„ä½¿ç”¨éçš„ bitstream bufferã€‚æ­¤è¡Œç‚ºé•åä¸€èˆ¬ callback ä½¿ç”¨å¸¸è­˜ï¼Œä½†ç¢ºå¯¦ç‚ºå¿…è¦æ“ä½œï¼Œå¦å‰‡ encoder å°‡ç„¡æ³•ç¹¼çºŒç”¢å‡º ESã€‚</p><hr><h2 id=send-input-frame-trace2025-08-01>Send Input Frame Traceï¼ˆ2025-08-01ï¼‰</h2><p><code>exe_encoder</code> ä¸»é‚è¼¯åœ¨ <code>SafeChannelMain()</code> è£¡ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#66d9ef>while</span> (...) {
</span></span><span style=display:flex><span>  LayerResources<span style=color:#f92672>::</span>SendInput(...);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><hr><h3 id=-function-call-trace>ğŸ” Function Call Trace</h3><pre tabindex=0><code>SafeChannelMain()
â””â”€ LayerResources::SendInput(cfg, enc.get(), traceHooker)
   â””â”€ sendInputFileTo(
        frameReader,
        SrcBufPool,
        SrcYuv.get(),
        cfg,
        FileInfo,
        pSrcConv.get(),
        firstSink,
        iPictCount,
        iReadCount
      )
      â””â”€ GetSrcFrame(
           iReadCount,
           iPictCount,
           frameReader,
           FileInfo,
           SrcBufPool,
           Yuv,
           tChParam,
           cfg,
           pSrcConv
         )
         â””â”€ ReadSourceFrame(SrcBufPool, Yuv, frameReader, tUpdatedDim, pSrcConv)
            â””â”€ ReadSourceFrameBuffer(pBuffer, conversionBuffer, frameReader, tUpdatedDim, pSrcConv)
               â”œâ”€ if conversion needed:
               â”‚    â”œâ”€ frameReader-&gt;ReadFrame(conversionBuffer)
               â”‚    â””â”€ pSrcConv-&gt;ConvertSrcBuf(conversionBuffer, pBuffer)
               â””â”€ else:
                    â””â”€ frameReader-&gt;ReadFrame(pBuffer)
</code></pre><hr><h3 id=-input-components-èªªæ˜>ğŸ§© Input Components èªªæ˜</h3><table><thead><tr><th>è®Šæ•¸å</th><th>é¡å‹ / ä¾†æº</th><th>å‚™è¨»</th></tr></thead><tbody><tr><td><code>frameReader</code></td><td><code>unique_ptr&lt;FrameReader></code></td><td>Instance variableï¼ˆUnCompFrameReaderï¼‰</td></tr><tr><td><code>SrcBufPool</code></td><td><code>PixMapBufPool</code></td><td>DMA allocator buffer pool</td></tr><tr><td><code>Yuv</code></td><td><code>AL_TBuffer *</code></td><td>ä½¿ç”¨ <code>SrcYuv.get()</code>ï¼ˆdefault allocatorï¼‰</td></tr><tr><td><code>pSrcConv</code></td><td><code>IConvSrc *</code></td><td>è‹¥éœ€è½‰æ›æ ¼å¼ï¼Œå¯¦é«”ç‚º <code>CYuvSrcConv</code></td></tr><tr><td><code>firstSink</code></td><td><code>IFrameSink *</code></td><td>encoder sinkï¼›<code>enc.get()</code></td></tr><tr><td><code>iPictCount</code></td><td><code>int</code></td><td>frame è¨ˆæ•¸å™¨</td></tr><tr><td><code>iReadCount</code></td><td><code>int</code></td><td>read è¨ˆæ•¸å™¨</td></tr></tbody></table><hr><h3 id=-ä¾†æºå»ºæ§‹æµç¨‹>ğŸ—ï¸ ä¾†æºå»ºæ§‹æµç¨‹</h3><ul><li><p><code>frameReader</code><br>â†’ <code>LayerResources::InitializeFrameReader()</code><br>â†’ é¡å‹ï¼š<code>UnCompFrameReader</code></p></li><li><p><code>pSrcConv</code><br>â†’ <code>AllocateSrcConverter()</code><br>â†’ è‹¥æ ¼å¼ä¸åŒï¼Œreturn <code>make_unique&lt;CYuvSrcConv></code></p></li><li><p><code>SrcYuv</code><br>â†’ <code>AllocateConversionBuffer(...)</code><br>â†’ åƒ…åœ¨éœ€è¦ format conversion æ™‚é…ç½®</p></li></ul><hr><h3 id=-read-è¡Œç‚ºç´°ç¯€>ğŸ“‚ Read è¡Œç‚ºç´°ç¯€</h3><ul><li><p><strong>è‹¥ç„¡éœ€æ ¼å¼è½‰æ›</strong>ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>frameReader<span style=color:#f92672>-&gt;</span>ReadFrame(pBuffer);
</span></span></code></pre></div></li><li><p><strong>è‹¥éœ€æ ¼å¼è½‰æ›ï¼ˆä¾‹å¦‚ I420 â†’ NV12ï¼‰</strong>ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>frameReader<span style=color:#f92672>-&gt;</span>ReadFrame(conversionBuffer);
</span></span><span style=display:flex><span>pSrcConv<span style=color:#f92672>-&gt;</span>ConvertSrcBuf(conversionBuffer, pBuffer);
</span></span></code></pre></div></li></ul><hr><h2 id=fetch-es-output-æ©Ÿåˆ¶ä¿®æ­£2025-07-30>Fetch ES Output æ©Ÿåˆ¶ä¿®æ­£ï¼ˆ2025-07-30ï¼‰</h2><p>åŸæœ¬çš„ callback å¯¦ä½œéŒ¯èª¤ï¼Œå°è‡´ encoder å¡ä½ç„¡æ³•ç¹¼çºŒè¼¸å‡º ESã€‚ç¶“æŸ¥è­‰ï¼Œå¿…é ˆåœ¨ callback return å‰ <strong>æ˜ç¢ºå‘¼å« <code>AL_Encoder_PutStreamBuffer()</code></strong> æ­¸é‚„ bitstream bufferï¼Œencoder æ‰èƒ½ç¹¼çºŒä½¿ç”¨è©² buffer é€²è¡Œç·¨ç¢¼ã€‚</p><h3 id=ä¿®æ­£å¾Œç¯„ä¾‹>ä¿®æ­£å¾Œç¯„ä¾‹ï¼š</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>myEndEncoding</span>(<span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>userParam, AL_TBuffer <span style=color:#f92672>*</span>pStream, AL_TBuffer <span style=color:#66d9ef>const</span> <span style=color:#f92672>*</span>pSrc, <span style=color:#66d9ef>int</span> iLayerID)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>uint8_t</span> <span style=color:#f92672>*</span>data <span style=color:#f92672>=</span> AL_Buffer_GetData(pStream);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  AL_TPictureMetaData <span style=color:#f92672>*</span>pPicMeta <span style=color:#f92672>=</span> (AL_TPictureMetaData <span style=color:#f92672>*</span>) AL_Buffer_GetMetaData(pStream, AL_META_TYPE_PICTURE);
</span></span><span style=display:flex><span>  printf(<span style=color:#e6db74>&#34;Picture Type %s %s</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, PictTypeToString(pPicMeta<span style=color:#f92672>-&gt;</span>eType).c_str(), pPicMeta<span style=color:#f92672>-&gt;</span>bSkipped <span style=color:#f92672>?</span> <span style=color:#e6db74>&#34;is skipped&#34;</span> <span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  AL_TStreamMetaData <span style=color:#f92672>*</span>pStreamMeta <span style=color:#f92672>=</span> (AL_TStreamMetaData <span style=color:#f92672>*</span>) AL_Buffer_GetMetaData(pStream, AL_META_TYPE_STREAM);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>uint16_t</span> i <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; i <span style=color:#f92672>&lt;</span> pStreamMeta<span style=color:#f92672>-&gt;</span>uNumSection; i<span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>    AL_TStreamSection section <span style=color:#f92672>=</span> pStreamMeta<span style=color:#f92672>-&gt;</span>pSections[i];
</span></span><span style=display:flex><span>    printf(<span style=color:#e6db74>&#34;Section %d: size=%d layer=%d, type=%s</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>,
</span></span><span style=display:flex><span>           i, section.uLength, iLayerID, SectionFlagToString(section.eFlags).c_str());
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// å¿…é ˆåœ¨ callback ä¸­é‚„åŸ bufferï¼Œå¦å‰‡ encoder æœƒå¡ä½
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>bool</span> bRet <span style=color:#f92672>=</span> AL_Encoder_PutStreamBuffer(__hEnc__, pStream);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>bRet) {
</span></span><span style=display:flex><span>    printf(<span style=color:#e6db74>&#34;AL_Encoder_PutStreamBuffer must always succeed</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=è¨»è§£>è¨»è§£</h3><p>é€™ç¨®åšæ³•ä»¤äººè²»è§£ã€‚ä¸€èˆ¬è€Œè¨€è‹¥ä½¿ç”¨ malloc åˆ†é… bufferï¼Œæ‡‰åœ¨å‘¼å« callback å¾Œåœ¨å‘¼å«ç«¯ freeï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>uint8_t</span> <span style=color:#f92672>*</span>buf <span style=color:#f92672>=</span> <span style=color:#a6e22e>malloc</span>(<span style=color:#ae81ff>100</span>);
</span></span><span style=display:flex><span><span style=color:#a6e22e>callback</span>(buf);
</span></span><span style=display:flex><span><span style=color:#a6e22e>free</span>(buf);  <span style=color:#75715e>// å‘¼å«ç«¯è² è²¬é‡‹æ”¾
</span></span></span></code></pre></div><p>ä½† Allegro SDK çš„æ¨¡å¼å»æ˜¯ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>AL_TBuffer <span style=color:#f92672>*</span>pStream <span style=color:#f92672>=</span> ...; <span style=color:#75715e>// ç”± encoder å¡«å¯«å®Œçš„ bitstream buffer
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>callback(pStream);         <span style=color:#75715e>// callback å…§éƒ¨è¦æ­¸é‚„ pStream ???
</span></span></span></code></pre></div><p>é€™ç¨®è¨­è¨ˆä¸ç¬¦åˆ callback çš„ä¸€èˆ¬ç”¨æ³•é‚è¼¯ï¼Œå±¬æ–¼è¨­è¨ˆéš±æ™¦çš„ API è¡Œç‚ºï¼Œéœ€é¡å¤–è¨»æ˜ã€‚</p><hr><h2 id=fetch-es-output-æ©Ÿåˆ¶ç¸½è¦½2025-07-23>Fetch ES Output æ©Ÿåˆ¶ç¸½è¦½ï¼ˆ2025-07-23ï¼‰</h2><p>åœ¨ä½¿ç”¨ <code>AL_Encoder_Process()</code> å°‡ frame æ¨å…¥ encoder å¾Œï¼ŒES bitstream ä¸¦éä¸»å‹•å‘¼å« API å›å‚³ï¼Œè€Œæ˜¯é€é <strong>callback æ©Ÿåˆ¶</strong>è§¸ç™¼æ¨é€å®Œæˆçš„ç·¨ç¢¼çµæœã€‚</p><h3 id=callback-å¯¦ä½œç¯„ä¾‹>Callback å¯¦ä½œç¯„ä¾‹</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>myEndEncoding</span>(<span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>userParam, AL_TBuffer <span style=color:#f92672>*</span>pStream, AL_TBuffer <span style=color:#66d9ef>const</span> <span style=color:#f92672>*</span>pSrc, <span style=color:#66d9ef>int</span> iLayerID)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>uint8_t</span> <span style=color:#f92672>*</span>data <span style=color:#f92672>=</span> AL_Buffer_GetData(pStream);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// è§£æ Picture metadata
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  AL_TPictureMetaData <span style=color:#f92672>*</span>pPicMeta <span style=color:#f92672>=</span> (AL_TPictureMetaData <span style=color:#f92672>*</span>) AL_Buffer_GetMetaData(pStream, AL_META_TYPE_PICTURE);
</span></span><span style=display:flex><span>  printf(<span style=color:#e6db74>&#34;Picture Type %s %s</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>,
</span></span><span style=display:flex><span>         PictTypeToString(pPicMeta<span style=color:#f92672>-&gt;</span>eType).c_str(),
</span></span><span style=display:flex><span>         pPicMeta<span style=color:#f92672>-&gt;</span>bSkipped <span style=color:#f92672>?</span> <span style=color:#e6db74>&#34;is skipped&#34;</span> <span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// è§£æ Stream metadata
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  AL_TStreamMetaData <span style=color:#f92672>*</span>pStreampMeta <span style=color:#f92672>=</span> (AL_TStreamMetaData <span style=color:#f92672>*</span>) AL_Buffer_GetMetaData(pStream, AL_META_TYPE_STREAM);
</span></span><span style=display:flex><span>  printf(<span style=color:#e6db74>&#34;sections = %d / %d</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, pStreampMeta<span style=color:#f92672>-&gt;</span>uNumSection, pStreampMeta<span style=color:#f92672>-&gt;</span>uMaxNumSection);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>uint16_t</span> i <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; i <span style=color:#f92672>&lt;</span> pStreampMeta<span style=color:#f92672>-&gt;</span>uNumSection; i<span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>    AL_TStreamSection section <span style=color:#f92672>=</span> pStreampMeta<span style=color:#f92672>-&gt;</span>pSections[i];
</span></span><span style=display:flex><span>    printf(<span style=color:#e6db74>&#34;section %d: size = %d</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, i, section.uLength);
</span></span><span style=display:flex><span>    hexprint(<span style=color:#e6db74>&#34;XX&#34;</span>, <span style=color:#f92672>&amp;</span>data[section.uOffset], min(section.uLength, <span style=color:#ae81ff>64</span>));
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=ç¶å®š-callback-åˆ°-encoder>ç¶å®š callback åˆ° encoder</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>AL_CB_EndEncoding endEncodingCb <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>  .func <span style=color:#f92672>=</span> myEndEncoding,
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>AL_Encoder_Create(..., endEncodingCb);
</span></span></code></pre></div><ul><li><code>AL_CB_EndEncoding</code> æ˜¯ Allegro å®šç¾©çš„ callback åŒ…è£çµæ§‹ã€‚</li><li><code>.func</code> å³ç‚ºç¶å®šçš„å‡½å¼æŒ‡æ¨™ã€‚</li></ul><h3 id=è£œå……èªªæ˜>è£œå……èªªæ˜</h3><ul><li>Bitstream å¯¦éš›å…§å®¹é€é <code>AL_TStreamMetaData</code> æè¿°ï¼Œå¯èƒ½åŒ…å«å¤šå€‹ sectionã€‚</li><li>æ¯å€‹ section éƒ½ç”± <code>uOffset</code>ï¼ˆæ–¼ AL_Buffer è³‡æ–™å€å…§çš„èµ·å§‹ä½ç½®ï¼‰èˆ‡ <code>uLength</code>ï¼ˆé•·åº¦ï¼‰çµ„æˆã€‚</li><li>è‹¥è¦ä¸²æ¥å°è£ï¼ˆå°ç‚º .h265 / .mp4ï¼‰æˆ–åˆ†æ bitstreamï¼Œå¯ç›´æ¥ç”±æ­¤è™•è¤‡è£½è³‡æ–™ã€‚</li></ul><hr><h2 id=attach-metadatabitstream-buffer2025-07-23>Attach MetaDataï¼šBitstream Bufferï¼ˆ2025-07-23ï¼‰</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>printf(<span style=color:#e6db74>&#34;AL_MAX_SECTION=%d</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, AL_MAX_SECTION);
</span></span><span style=display:flex><span>AL_TStreamMetaData <span style=color:#f92672>*</span>pStreamMeta <span style=color:#f92672>=</span> AL_StreamMetaData_Create(AL_MAX_SECTION);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>bool</span> isOk <span style=color:#f92672>=</span> AL_Buffer_AddMetaData(pBsBuf, (AL_TMetaData <span style=color:#f92672>*</span>) pStreamMeta);
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>isOk) {
</span></span><span style=display:flex><span>  printf(<span style=color:#e6db74>&#34;Failed to attach metadata to bitstream buffer</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>  printf(<span style=color:#e6db74>&#34;%d ok!</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, __LINE__);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><a href=#al_encoder_putstreambuffer-failed-bitstream-buffer-needs-pmetadata2025-07-17>è§£æ±º issue</a></p><hr><h2 id=attach-metadatasource-buffer-yuv-input2025-07-23>Attach MetaDataï¼šSource Buffer (YUV Input)ï¼ˆ2025-07-23ï¼‰</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>AL_TDimension tDim <span style=color:#f92672>=</span> { settings.tChParam[<span style=color:#ae81ff>0</span>].uSrcWidth, settings.tChParam[<span style=color:#ae81ff>0</span>].uSrcHeight };
</span></span><span style=display:flex><span>AL_TPlane tYPlane <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>  .iChunkIdx <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span>  .iOffset <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span>  .iPitch <span style=color:#f92672>=</span> tDim.iWidth,
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>AL_TPlane tUVPlane <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>  .iChunkIdx <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span>  .iOffset <span style=color:#f92672>=</span> tYPlane.iPitch <span style=color:#f92672>*</span> tDim.iHeight,
</span></span><span style=display:flex><span>  .iPitch <span style=color:#f92672>=</span> tYPlane.iPitch
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>AL_TPicFormat tPictFormat <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>  .eChromaMode <span style=color:#f92672>=</span> AL_CHROMA_4_2_0,
</span></span><span style=display:flex><span>  .eAlphaMode <span style=color:#f92672>=</span> AL_ALPHA_MODE_DISABLED,
</span></span><span style=display:flex><span>  .uBitDepth <span style=color:#f92672>=</span> <span style=color:#ae81ff>8</span>,
</span></span><span style=display:flex><span>  .eStorageMode <span style=color:#f92672>=</span> AL_FB_RASTER,
</span></span><span style=display:flex><span>  .ePlaneMode <span style=color:#f92672>=</span> AL_PLANE_MODE_SEMIPLANAR,
</span></span><span style=display:flex><span>  .eComponentOrder <span style=color:#f92672>=</span> AL_COMPONENT_ORDER_YUV,
</span></span><span style=display:flex><span>  .eSamplePackMode <span style=color:#f92672>=</span> AL_SAMPLE_PACK_MODE_BYTE,
</span></span><span style=display:flex><span>  .bCompressed <span style=color:#f92672>=</span> false,
</span></span><span style=display:flex><span>  .bMSB <span style=color:#f92672>=</span> false,
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>TFourCC tFourCC <span style=color:#f92672>=</span> AL_GetFourCC(tPictFormat);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>AL_TMetaData <span style=color:#f92672>*</span>pPixMapMeta <span style=color:#f92672>=</span> (AL_TMetaData <span style=color:#f92672>*</span>) AL_PixMapMetaData_Create(tDim, tYPlane, tUVPlane, tFourCC);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>bool</span> isOk <span style=color:#f92672>=</span> AL_Buffer_AddMetaData(pYuvBuf, pPixMapMeta);
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>isOk) {
</span></span><span style=display:flex><span>  printf(<span style=color:#e6db74>&#34;Failed to attach metadata to source buffer</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>  printf(<span style=color:#e6db74>&#34;%d ok!</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, __LINE__);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><hr><h2 id=al_encoder_putstreambuffer-failed-bitstream-buffer-needs-pmetadata2025-07-17>AL_Encoder_PutStreamBuffer() failed, bitstream buffer needs pMetaDataï¼ˆ2025-07-17ï¼‰</h2><p><strong>éŒ¯èª¤è¨Šæ¯</strong>ï¼š</p><pre tabindex=0><code>[/lib_encode/Com_Encoder.c:164] pMetaData
lib_rtos.c:39: Rtos_AssertWithMessage: Assertion `false&#39; failed.
</code></pre><p><strong>åŸå› èªªæ˜</strong>ï¼š</p><ul><li><code>pBsBuf</code> ç‚º encoder è¼¸å‡ºç”¨çš„ bitstream bufferï¼Œä½† <code>AL_TBuffer->pMetaData == NULL</code>ã€‚</li><li>encoder å…§éƒ¨éœ€è¦ metadata ä¾†è¨˜éŒ„ output sizeã€NAL info ç­‰ï¼Œè‹¥ç‚º null æœƒè§¸ç™¼ç¡¬æ€§ assertã€‚</li></ul><p><strong>ç›®å‰ç‹€æ³</strong>ï¼š</p><ul><li>å°šæœªæ‰¾åˆ°æ­£ç¢ºå»ºç«‹ <code>AL_TBuffer</code> çµ¦ <code>AL_Encoder_PutStreamBuffer()</code> ä½¿ç”¨çš„å®Œæ•´åšæ³•ã€‚</li><li>è¨ˆç•«é€²ä¸€æ­¥æ·±å…¥ trace <code>exe_encoder</code>ï¼Œç¢ºèªå¯¦éš›å»ºç«‹èˆ‡ä½¿ç”¨çš„æµç¨‹ã€‚</li><li>æ­¤é …å¾ŒçºŒè£œå……æ›´æ–°ã€‚</li></ul><hr><h2 id=al_encoder_create-å¤±æ•—åŸå› éåƒæ•¸éŒ¯èª¤è€Œæ˜¯-allocator-éŒ¯ç”¨2025-07-17><code>AL_Encoder_Create()</code> å¤±æ•—åŸå› éåƒæ•¸éŒ¯èª¤ï¼Œè€Œæ˜¯ allocator éŒ¯ç”¨ï¼ˆ2025-07-17ï¼‰</h2><p><strong>åŸå…ˆå‡è¨­</strong>ï¼š<code>AL_TEncSettings</code> è¨­å®šæœ‰èª¤ï¼Œèˆ‡ <code>exe_encoder</code> å°é½Šå¾Œä»å¤±æ•—ã€‚
<strong>çœŸæ­£åŸå› </strong>ï¼šä½¿ç”¨äº†éŒ¯èª¤çš„ allocatorã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>AL_TAllocator <span style=color:#f92672>*</span>pAllocator <span style=color:#f92672>=</span> AL_GetDefaultAllocator(); <span style=color:#75715e>// âŒ åƒ…ç‚º malloc()ï¼Œé DMA
</span></span></span></code></pre></div><p><strong>åˆ†æ</strong>ï¼š</p><ul><li>è©² allocator åˆ†é…çš„æ˜¯ host heap memoryï¼Œç¡¬é«”ç„¡æ³• DMA å­˜å–ã€‚</li><li><code>AL_Encoder_Create()</code> åœ¨æª¢æŸ¥ input/output buffer æ˜¯å¦ DMA buffer æ™‚è§¸ç™¼éŒ¯èª¤: (al5e a0200000.al5e: VCU: unavailable resources or wrong configuration)ã€‚</li></ul><p><strong>æ­£ç¢ºåšæ³•</strong>ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>AL_TAllocator <span style=color:#f92672>*</span>pAllocator <span style=color:#f92672>=</span> AL_DmaAlloc_Create(<span style=color:#e6db74>&#34;/dev/allegroIP&#34;</span>); <span style=color:#75715e>// âœ…
</span></span></span></code></pre></div><ul><li>è©²å‡½å¼é€é driver åˆ†é… DMA bufferï¼ˆå¯¦é«”è¨˜æ†¶é«”ï¼‰ï¼Œä¸¦ç”¨ <code>mmap()</code> æ˜ å°„åˆ° hostï¼Œå¯å®‰å…¨äº¤ç”± encoder ä½¿ç”¨ã€‚</li></ul><hr><h2 id=allegro_min_enc-crash-åŸå› æ’æŸ¥å®Œæˆ2025-07-10><code>allegro_min_enc</code> crash åŸå› æ’æŸ¥å®Œæˆï¼ˆ2025-07-10ï¼‰</h2><p><strong>éŒ¯èª¤è¨Šæ¯</strong>ï¼š</p><pre tabindex=0><code>pSubHrdParam-&gt;bit_rate_value_minus1[0] &lt;= (UINT32_MAX - 1)
allegro_min_enc: Rtos_AssertWithMessage: Assertion `false&#39; failed.
</code></pre><p><strong>æ¨è«–</strong>ï¼š</p><ul><li><code>AL_TEncSettings</code> çµæ§‹æ¥µåº¦è¤‡é›œï¼Œç¼ºä¹åƒè€ƒå€¼èˆ‡é è¨­çµ„åˆã€‚</li><li>å¯èƒ½æ¬„ä½ä¹‹é–“è¡çªï¼Œå°è‡´ encoder å»ºç«‹å¤±æ•—ã€‚</li></ul><p><strong>è™•ç†æ–¹å¼</strong>ï¼š</p><ul><li>æš«æ™‚è·³é <code>allegro_min_enc</code> æ¸¬è©¦ã€‚</li><li>æ”¹æ¡å·²ç¢ºèªç©©å®šçš„ <code>exe_encoder</code> åŸ·è¡Œæª”é€²è¡Œé–‹ç™¼èˆ‡é©—è­‰ã€‚</li><li>åˆ©ç”¨ <code>EncoderSink</code> åŠ print debug æŠ€è¡“åˆ†æ <code>AL_TEncSettings</code> æ­£ç¢ºå€¼ã€‚</li></ul><hr><h2 id=ä½¿ç”¨-exe_encoder-ä¸¦åˆ—å°-al_tencsettings2025-07-10>ä½¿ç”¨ <code>exe_encoder</code> ä¸¦åˆ—å° <code>AL_TEncSettings</code>ï¼ˆ2025-07-10ï¼‰</h2><ul><li>æˆåŠŸåŸ·è¡Œ <code>exe_encoder</code>ï¼Œå®Œæˆæ¸¬è©¦ YUV ç·¨ç¢¼ã€‚</li><li>ä¿®æ”¹ encoder ä¸»ç¨‹å¼ï¼Œ<strong>å®Œæ•´å°å‡º <code>AL_TEncSettings</code> çµæ§‹æ‰€æœ‰æ¬„ä½</strong>ï¼Œä¾¿æ–¼å¾ŒçºŒç¨‹å¼æ¯”å°èˆ‡èª¿åƒã€‚</li></ul><hr><h2 id=build-æ­£ç¢ºç‰ˆæœ¬çš„-vcu-control-swvcu-202512025-07-10>Build æ­£ç¢ºç‰ˆæœ¬çš„ VCU Control SWï¼š<code>VCU 2025.1</code>ï¼ˆ2025-07-10ï¼‰</h2><p><strong>é—œéµç™¼ç¾</strong>ï¼š
é›–ç„¶ <code>VCU 2023.1</code> å¯ç·¨è­¯ï¼Œä½† encoder å¯¦éš›é‹è¡Œæœƒ crashã€‚
å¿…é ˆä½¿ç”¨ <code>VCU 2025.1</code>ï¼Œæ‰èƒ½ç©©å®šé€²è¡Œ encodingã€‚</p><p><strong>ç·¨è­¯æ­¥é©Ÿ</strong>ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># è¨­å®š cross compile ç’°å¢ƒ</span>
</span></span><span style=display:flex><span>source ~/VEGA2200/trunk/xilinx_sdk_r5_vega6000/sdk/environment-setup-cortexa72-cortexa53-xilinx-linux
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># é€²å…¥æ­£ç¢ºç‰ˆæœ¬çš„ source tree</span>
</span></span><span style=display:flex><span>cd ~/vcu-ctrl-sw-xlnx_rel_v2025.1
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># ç·¨è­¯</span>
</span></span><span style=display:flex><span>make -j8
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># ç¢ºèªè¼¸å‡ºæª”æ¡ˆå‹æ…‹</span>
</span></span><span style=display:flex><span>file bin/AL_Encoder.exe
</span></span></code></pre></div><p><strong>æˆæœ</strong>ï¼š</p><ul><li>æˆåŠŸç”¢å‡º <code>AL_Encoder.exe</code>ï¼Œå¯æ–¼ ZCU106 æ­£å¸¸é‹è¡Œã€‚</li><li>è¼¸å‡º YUV encode çµæœæ­£ç¢ºï¼Œbitrate ç¬¦åˆé æœŸï¼Œè­‰å¯¦ encoder pipeline å¯ç”¨ã€‚</li></ul><hr></section><div class=post-tags><nav class="nav tags"><ul class=tags><li><a href=/tags/vcu>VCU</a></li></ul></nav></div></div></div></article></main><footer><div style=display:flex></div><div class=footer-info>2025 <a href=https://github.com/athul/archie>Archie Theme</a> | Built with <a href=https://gohugo.io>Hugo</a></div></footer></div></body></html>