<!doctype html><html><head lang=en><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><title>VCU é–‹ç™¼é€²åº¦ç¸½çµ â€” 2025-07-25 - Hank Tech Lab</title><meta name=viewport content="width=device-width,initial-scale=1">
<meta name=description content='VCU é–‹ç™¼é€²åº¦ç¸½çµï¼ˆæˆªè‡³ 2025-07-25ï¼‰ ğŸ§© Callback æ©Ÿåˆ¶ç¸½è¦½ åœ¨ä½¿ç”¨ AL_Encoder_Process() å°‡ frame æ¨å…¥ encoder å¾Œï¼Œbitstream ä¸¦éä¸»å‹•ç”± API å›å‚³ï¼Œè€Œæ˜¯é€é callback æ©Ÿåˆ¶ä¸»å‹•æ¨é€å®Œæˆçš„ç·¨ç¢¼çµæœã€‚
âœ… Callback å¯¦ä½œç¯„ä¾‹ void myEndEncoding(void *userParam, AL_TBuffer *pStream, AL_TBuffer const *pSrc, int iLayerID) { uint8_t *data = AL_Buffer_GetData(pStream); // è§£æ Picture metadata AL_TPictureMetaData *pPicMeta = (AL_TPictureMetaData *) AL_Buffer_GetMetaData(pStream, AL_META_TYPE_PICTURE); printf("Picture Type %s %s\n", PictTypeToString(pPicMeta->eType).c_str(), pPicMeta->bSkipped ? "is skipped" : ""); // è§£æ Stream metadata AL_TStreamMetaData *pStreampMeta = (AL_TStreamMetaData *) AL_Buffer_GetMetaData(pStream, AL_META_TYPE_STREAM); printf("sections = %d / %d\n", pStreampMeta->uNumSection, pStreampMeta->uMaxNumSection); for (uint16_t i = 0; i < pStreampMeta->uNumSection; i++) { AL_TStreamSection section = pStreampMeta->pSections[i]; printf("section %d: size = %d\n", i, section.'><meta property="og:image" content><meta property="og:url" content="https://hanketgithub.github.io/tech/vcu_progress_2025-07-25/"><meta property="og:site_name" content="Hank Tech Lab"><meta property="og:title" content="VCU é–‹ç™¼é€²åº¦ç¸½çµ â€” 2025-07-25"><meta property="og:description" content='VCU é–‹ç™¼é€²åº¦ç¸½çµï¼ˆæˆªè‡³ 2025-07-25ï¼‰ ğŸ§© Callback æ©Ÿåˆ¶ç¸½è¦½ åœ¨ä½¿ç”¨ AL_Encoder_Process() å°‡ frame æ¨å…¥ encoder å¾Œï¼Œbitstream ä¸¦éä¸»å‹•ç”± API å›å‚³ï¼Œè€Œæ˜¯é€é callback æ©Ÿåˆ¶ä¸»å‹•æ¨é€å®Œæˆçš„ç·¨ç¢¼çµæœã€‚
âœ… Callback å¯¦ä½œç¯„ä¾‹ void myEndEncoding(void *userParam, AL_TBuffer *pStream, AL_TBuffer const *pSrc, int iLayerID) { uint8_t *data = AL_Buffer_GetData(pStream); // è§£æ Picture metadata AL_TPictureMetaData *pPicMeta = (AL_TPictureMetaData *) AL_Buffer_GetMetaData(pStream, AL_META_TYPE_PICTURE); printf("Picture Type %s %s\n", PictTypeToString(pPicMeta->eType).c_str(), pPicMeta->bSkipped ? "is skipped" : ""); // è§£æ Stream metadata AL_TStreamMetaData *pStreampMeta = (AL_TStreamMetaData *) AL_Buffer_GetMetaData(pStream, AL_META_TYPE_STREAM); printf("sections = %d / %d\n", pStreampMeta->uNumSection, pStreampMeta->uMaxNumSection); for (uint16_t i = 0; i < pStreampMeta->uNumSection; i++) { AL_TStreamSection section = pStreampMeta->pSections[i]; printf("section %d: size = %d\n", i, section.'><meta property="og:locale" content="en-us"><meta property="og:type" content="article"><meta property="article:section" content="tech"><meta property="article:published_time" content="2025-07-25T00:00:00+00:00"><meta property="article:modified_time" content="2025-07-25T00:00:00+00:00"><meta property="article:tag" content="VCU"><meta name=twitter:card content="summary"><meta name=twitter:title content="VCU é–‹ç™¼é€²åº¦ç¸½çµ â€” 2025-07-25"><meta name=twitter:description content='VCU é–‹ç™¼é€²åº¦ç¸½çµï¼ˆæˆªè‡³ 2025-07-25ï¼‰ ğŸ§© Callback æ©Ÿåˆ¶ç¸½è¦½ åœ¨ä½¿ç”¨ AL_Encoder_Process() å°‡ frame æ¨å…¥ encoder å¾Œï¼Œbitstream ä¸¦éä¸»å‹•ç”± API å›å‚³ï¼Œè€Œæ˜¯é€é callback æ©Ÿåˆ¶ä¸»å‹•æ¨é€å®Œæˆçš„ç·¨ç¢¼çµæœã€‚
âœ… Callback å¯¦ä½œç¯„ä¾‹ void myEndEncoding(void *userParam, AL_TBuffer *pStream, AL_TBuffer const *pSrc, int iLayerID) { uint8_t *data = AL_Buffer_GetData(pStream); // è§£æ Picture metadata AL_TPictureMetaData *pPicMeta = (AL_TPictureMetaData *) AL_Buffer_GetMetaData(pStream, AL_META_TYPE_PICTURE); printf("Picture Type %s %s\n", PictTypeToString(pPicMeta->eType).c_str(), pPicMeta->bSkipped ? "is skipped" : ""); // è§£æ Stream metadata AL_TStreamMetaData *pStreampMeta = (AL_TStreamMetaData *) AL_Buffer_GetMetaData(pStream, AL_META_TYPE_STREAM); printf("sections = %d / %d\n", pStreampMeta->uNumSection, pStreampMeta->uMaxNumSection); for (uint16_t i = 0; i < pStreampMeta->uNumSection; i++) { AL_TStreamSection section = pStreampMeta->pSections[i]; printf("section %d: size = %d\n", i, section.'><link href=https://hanketgithub.github.io/css/fonts.2c2227b81b1970a03e760aa2e6121cd01f87c88586803cbb282aa224720a765f.css rel=stylesheet><link rel=stylesheet type=text/css media=screen href=https://hanketgithub.github.io/css/main.6a0f23ea50fd34b46fee262a5a68e17d458c51a2bc99ba1ba018065de6b180c3.css><link id=darkModeStyle rel=stylesheet type=text/css href=https://hanketgithub.github.io/css/dark.50b57e12d401420df23965fed157368aba37b76df0ecefd0b1ecd4da664f01a0.css disabled><style>@media print{body{font-family:pingfang tc,helvetica neue,sans-serif;font-size:12pt;line-height:1.6;color:#000}table,th,td{border:1px solid #666;border-collapse:collapse}th,td{padding:8px 12px;text-align:left}h1,h2{page-break-before:always}h1:first-of-type,h2:first-of-type{page-break-before:auto}img{max-width:100%;height:auto;page-break-inside:avoid}p{page-break-inside:avoid}a{color:#000;text-decoration:none}}</style></head><body><div class=content><header><div class=main><a href=https://hanketgithub.github.io/>Hank Tech Lab</a></div><nav><a href=/posts/>Posts</a>
| <span id=dark-mode-toggle onclick=toggleTheme()><svg class="feather"><use href="/svg/feather-sprite.51cf5647cb1987f769b616558f2620fd9423d72058490231b391bf6aa3744b55.svg#sun"/></svg></span>
<script src=https://hanketgithub.github.io/js/themetoggle.js></script></nav></header><main><article><div class=post-container><div class=post-content><div class=title><h1 class=title>VCU é–‹ç™¼é€²åº¦ç¸½çµ â€” 2025-07-25</h1><div class=meta>Posted on Jul 25, 2025</div></div><section class=body><h1 id=vcu-é–‹ç™¼é€²åº¦ç¸½çµæˆªè‡³-2025-07-25>VCU é–‹ç™¼é€²åº¦ç¸½çµï¼ˆæˆªè‡³ 2025-07-25ï¼‰</h1><hr><h2 id=-callback-æ©Ÿåˆ¶ç¸½è¦½>ğŸ§© Callback æ©Ÿåˆ¶ç¸½è¦½</h2><p>åœ¨ä½¿ç”¨ <code>AL_Encoder_Process()</code> å°‡ frame æ¨å…¥ encoder å¾Œï¼Œbitstream ä¸¦éä¸»å‹•ç”± API å›å‚³ï¼Œè€Œæ˜¯é€é <strong>callback æ©Ÿåˆ¶</strong>ä¸»å‹•æ¨é€å®Œæˆçš„ç·¨ç¢¼çµæœã€‚</p><hr><h2 id=-callback-å¯¦ä½œç¯„ä¾‹>âœ… Callback å¯¦ä½œç¯„ä¾‹</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>myEndEncoding</span>(<span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>userParam, AL_TBuffer <span style=color:#f92672>*</span>pStream, AL_TBuffer <span style=color:#66d9ef>const</span> <span style=color:#f92672>*</span>pSrc, <span style=color:#66d9ef>int</span> iLayerID)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>uint8_t</span> <span style=color:#f92672>*</span>data <span style=color:#f92672>=</span> AL_Buffer_GetData(pStream);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// è§£æ Picture metadata
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  AL_TPictureMetaData <span style=color:#f92672>*</span>pPicMeta <span style=color:#f92672>=</span> (AL_TPictureMetaData <span style=color:#f92672>*</span>) AL_Buffer_GetMetaData(pStream, AL_META_TYPE_PICTURE);
</span></span><span style=display:flex><span>  printf(<span style=color:#e6db74>&#34;Picture Type %s %s</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>,
</span></span><span style=display:flex><span>         PictTypeToString(pPicMeta<span style=color:#f92672>-&gt;</span>eType).c_str(),
</span></span><span style=display:flex><span>         pPicMeta<span style=color:#f92672>-&gt;</span>bSkipped <span style=color:#f92672>?</span> <span style=color:#e6db74>&#34;is skipped&#34;</span> <span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// è§£æ Stream metadata
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  AL_TStreamMetaData <span style=color:#f92672>*</span>pStreampMeta <span style=color:#f92672>=</span> (AL_TStreamMetaData <span style=color:#f92672>*</span>) AL_Buffer_GetMetaData(pStream, AL_META_TYPE_STREAM);
</span></span><span style=display:flex><span>  printf(<span style=color:#e6db74>&#34;sections = %d / %d</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, pStreampMeta<span style=color:#f92672>-&gt;</span>uNumSection, pStreampMeta<span style=color:#f92672>-&gt;</span>uMaxNumSection);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>uint16_t</span> i <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; i <span style=color:#f92672>&lt;</span> pStreampMeta<span style=color:#f92672>-&gt;</span>uNumSection; i<span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>    AL_TStreamSection section <span style=color:#f92672>=</span> pStreampMeta<span style=color:#f92672>-&gt;</span>pSections[i];
</span></span><span style=display:flex><span>    printf(<span style=color:#e6db74>&#34;section %d: size = %d</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, i, section.uLength);
</span></span><span style=display:flex><span>    hexprint(<span style=color:#e6db74>&#34;XX&#34;</span>, <span style=color:#f92672>&amp;</span>data[section.uOffset], <span style=color:#ae81ff>64</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><hr><h2 id=-ç¶å®š-callback-åˆ°-encoder>ğŸ— ç¶å®š callback åˆ° encoder</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>AL_CB_EndEncoding endEncodingCb <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>  .func <span style=color:#f92672>=</span> myEndEncoding,
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>AL_Encoder_Create(..., endEncodingCb);
</span></span></code></pre></div><ul><li><code>AL_CB_EndEncoding</code> æ˜¯ Allegro å®šç¾©çš„ callback åŒ…è£çµæ§‹ã€‚</li><li><code>.func</code> å³ç‚ºç¶å®šçš„å‡½å¼æŒ‡æ¨™ã€‚</li></ul><hr><h2 id=-è£œå……èªªæ˜>ğŸ“¦ è£œå……èªªæ˜</h2><ul><li>Bitstream å¯¦éš›å…§å®¹é€é <code>AL_TStreamMetaData</code> æè¿°ï¼Œå¯èƒ½åŒ…å«å¤šå€‹ sectionã€‚</li><li>æ¯å€‹ section éƒ½ç”± <code>uOffset</code>ï¼ˆæ–¼ AL_Buffer è³‡æ–™å€å…§çš„èµ·å§‹ä½ç½®ï¼‰èˆ‡ <code>uLength</code>ï¼ˆé•·åº¦ï¼‰çµ„æˆã€‚</li><li>è‹¥è¦ä¸²æ¥å°è£ï¼ˆå°ç‚º .h265 / .mp4ï¼‰æˆ–åˆ†æ bitstreamï¼Œå¯ç›´æ¥ç”±æ­¤è™•è¤‡è£½è³‡æ–™ã€‚</li></ul><hr><h2 id=-attach-metadatabitstream-buffer>ğŸ§· Attach MetaDataï¼šBitstream Buffer</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>printf(<span style=color:#e6db74>&#34;AL_MAX_SECTION=%d</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, AL_MAX_SECTION);
</span></span><span style=display:flex><span>AL_TStreamMetaData <span style=color:#f92672>*</span>pStreamMeta <span style=color:#f92672>=</span> AL_StreamMetaData_Create(AL_MAX_SECTION);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>bool</span> isOk <span style=color:#f92672>=</span> AL_Buffer_AddMetaData(pBsBuf, (AL_TMetaData <span style=color:#f92672>*</span>) pStreamMeta);
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>isOk) {
</span></span><span style=display:flex><span>  printf(<span style=color:#e6db74>&#34;Failed to attach metadata to bitstream buffer</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>  printf(<span style=color:#e6db74>&#34;%d ok!</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, __LINE__);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><hr><h2 id=-attach-metadatasource-buffer-yuv-input>ğŸ§· Attach MetaDataï¼šSource Buffer (YUV Input)</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>AL_TDimension tDim <span style=color:#f92672>=</span> { settings.tChParam[<span style=color:#ae81ff>0</span>].uSrcWidth, settings.tChParam[<span style=color:#ae81ff>0</span>].uSrcHeight };
</span></span><span style=display:flex><span>AL_TPlane tYPlane <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>  .iChunkIdx <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span>  .iOffset <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span>  .iPitch <span style=color:#f92672>=</span> tDim.iWidth,
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>AL_TPlane tUVPlane <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>  .iChunkIdx <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span>  .iOffset <span style=color:#f92672>=</span> tYPlane.iPitch <span style=color:#f92672>*</span> tDim.iHeight,
</span></span><span style=display:flex><span>  .iPitch <span style=color:#f92672>=</span> tYPlane.iPitch
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>AL_TPicFormat tPictFormat <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>  .eChromaMode <span style=color:#f92672>=</span> AL_CHROMA_4_2_0,
</span></span><span style=display:flex><span>  .eAlphaMode <span style=color:#f92672>=</span> AL_ALPHA_MODE_DISABLED,
</span></span><span style=display:flex><span>  .uBitDepth <span style=color:#f92672>=</span> <span style=color:#ae81ff>8</span>,
</span></span><span style=display:flex><span>  .eStorageMode <span style=color:#f92672>=</span> AL_FB_RASTER,
</span></span><span style=display:flex><span>  .ePlaneMode <span style=color:#f92672>=</span> AL_PLANE_MODE_SEMIPLANAR,
</span></span><span style=display:flex><span>  .eComponentOrder <span style=color:#f92672>=</span> AL_COMPONENT_ORDER_YUV,
</span></span><span style=display:flex><span>  .eSamplePackMode <span style=color:#f92672>=</span> AL_SAMPLE_PACK_MODE_BYTE,
</span></span><span style=display:flex><span>  .bCompressed <span style=color:#f92672>=</span> false,
</span></span><span style=display:flex><span>  .bMSB <span style=color:#f92672>=</span> false,
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>TFourCC tFourCC <span style=color:#f92672>=</span> AL_GetFourCC(tPictFormat);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>AL_TMetaData <span style=color:#f92672>*</span>pPixMapMeta <span style=color:#f92672>=</span> (AL_TMetaData <span style=color:#f92672>*</span>) AL_PixMapMetaData_Create(tDim, tYPlane, tUVPlane, tFourCC);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>bool</span> isOk <span style=color:#f92672>=</span> AL_Buffer_AddMetaData(pYuvBuf, pPixMapMeta);
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>isOk) {
</span></span><span style=display:flex><span>  printf(<span style=color:#e6db74>&#34;Failed to attach metadata to source buffer</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>  printf(<span style=color:#e6db74>&#34;%d ok!</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, __LINE__);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><hr><p>âœ… <strong>æ­¤æ©Ÿåˆ¶å·²æˆåŠŸé©—è­‰ï¼Œå»ºè­°ç´å…¥ encoding pipeline çš„å¾Œè™•ç†æ¨¡çµ„ã€‚</strong></p><hr><h2 id=-1-al_encoder_putstreambuffer-å¤±æ•—bitstream-buffer-ç¼ºå°‘-pmetadata2025-07-17>âœ… 1. <code>AL_Encoder_PutStreamBuffer()</code> å¤±æ•—ï¼Œbitstream buffer ç¼ºå°‘ pMetaDataï¼ˆ2025-07-17ï¼‰</h2><ul><li><p><strong>éŒ¯èª¤è¨Šæ¯</strong>ï¼š</p><pre tabindex=0><code>[/lib_encode/Com_Encoder.c:164] pMetaData
lib_rtos.c:39: Rtos_AssertWithMessage: Assertion `false&#39; failed.
</code></pre></li><li><p><strong>åŸå› èªªæ˜</strong>ï¼š</p><ul><li><code>pBsBuf</code> ç‚º encoder è¼¸å‡ºç”¨çš„ bitstream bufferï¼Œä½† <code>AL_TBuffer->pMetaData == NULL</code>ã€‚</li><li>encoder å…§éƒ¨éœ€è¦ metadata ä¾†è¨˜éŒ„ output sizeã€NAL info ç­‰ï¼Œè‹¥ç‚º null æœƒè§¸ç™¼ç¡¬æ€§ assertã€‚</li></ul></li><li><p><strong>ç›®å‰ç‹€æ³</strong>ï¼š</p><ul><li>å°šæœªæ‰¾åˆ°æ­£ç¢ºå»ºç«‹ <code>AL_TBuffer</code> çµ¦ <code>AL_Encoder_PutStreamBuffer()</code> ä½¿ç”¨çš„å®Œæ•´åšæ³•ã€‚</li><li>è¨ˆç•«é€²ä¸€æ­¥æ·±å…¥ trace <code>exe_encoder</code>ï¼Œç¢ºèªå¯¦éš›å»ºç«‹èˆ‡ä½¿ç”¨çš„æµç¨‹ã€‚</li><li>æ­¤é …å¾ŒçºŒè£œå……æ›´æ–°ã€‚</li></ul></li></ul><hr><h2 id=-2-al_encoder_create-å¤±æ•—åŸå› éåƒæ•¸éŒ¯èª¤è€Œæ˜¯-allocator-éŒ¯ç”¨2025-07-17>âœ… 2. <code>AL_Encoder_Create()</code> å¤±æ•—åŸå› éåƒæ•¸éŒ¯èª¤ï¼Œè€Œæ˜¯ allocator éŒ¯ç”¨ï¼ˆ2025-07-17ï¼‰</h2><ul><li><p><strong>åŸå…ˆå‡è¨­</strong>ï¼š<code>AL_TEncSettings</code> è¨­å®šæœ‰èª¤ï¼Œèˆ‡ <code>exe_encoder</code> å°é½Šå¾Œä»å¤±æ•—ã€‚</p></li><li><p><strong>çœŸæ­£åŸå› </strong>ï¼šä½¿ç”¨äº†éŒ¯èª¤çš„ allocatorã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>AL_TAllocator<span style=color:#f92672>*</span> pAllocator <span style=color:#f92672>=</span> AL_GetDefaultAllocator(); <span style=color:#75715e>// âŒ åƒ…ç‚º malloc()ï¼Œé DMA
</span></span></span></code></pre></div></li><li><p><strong>åˆ†æ</strong>ï¼š</p><ul><li>è©² allocator åˆ†é…çš„æ˜¯ host heap memoryï¼Œç¡¬é«”ç„¡æ³• DMA å­˜å–ã€‚</li><li><code>AL_Encoder_Create()</code> åœ¨æª¢æŸ¥ input/output buffer æ˜¯å¦ DMA buffer æ™‚è§¸ç™¼éŒ¯èª¤: (al5e a0200000.al5e: VCU: unavailable resources or wrong configuration)ã€‚</li></ul></li><li><p><strong>æ­£ç¢ºåšæ³•</strong>ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>AL_TAllocator<span style=color:#f92672>*</span> pAllocator <span style=color:#f92672>=</span> AL_DmaAlloc_Create(<span style=color:#e6db74>&#34;/dev/allegroIP&#34;</span>); <span style=color:#75715e>// âœ…
</span></span></span></code></pre></div><ul><li>è©²å‡½å¼é€é driver åˆ†é… DMA bufferï¼ˆå¯¦é«”è¨˜æ†¶é«”ï¼‰ï¼Œä¸¦ç”¨ <code>mmap()</code> æ˜ å°„åˆ° hostï¼Œå¯å®‰å…¨äº¤ç”± encoder ä½¿ç”¨ã€‚</li></ul></li></ul><hr><h2 id=-3-allegro_min_enc-crash-åŸå› æ’æŸ¥å®Œæˆ2025-07-10>âœ… 3. <code>allegro_min_enc</code> crash åŸå› æ’æŸ¥å®Œæˆï¼ˆ2025-07-10ï¼‰</h2><ul><li><p><strong>éŒ¯èª¤è¨Šæ¯</strong>ï¼š</p><pre tabindex=0><code>pSubHrdParam-&gt;bit_rate_value_minus1[0] &lt;= (UINT32_MAX - 1)
allegro_min_enc: Rtos_AssertWithMessage: Assertion `false&#39; failed.
</code></pre></li><li><p><strong>æ¨è«–</strong>ï¼š</p><ul><li><code>AL_TEncSettings</code> çµæ§‹æ¥µåº¦è¤‡é›œï¼Œç¼ºä¹åƒè€ƒå€¼èˆ‡é è¨­çµ„åˆã€‚</li><li>å¯èƒ½æ¬„ä½ä¹‹é–“è¡çªï¼Œå°è‡´ encoder å»ºç«‹å¤±æ•—ã€‚</li></ul></li><li><p><strong>è™•ç†æ–¹å¼</strong>ï¼š</p><ul><li>æš«æ™‚è·³é <code>allegro_min_enc</code> æ¸¬è©¦ã€‚</li><li>æ”¹æ¡å·²ç¢ºèªç©©å®šçš„ <code>exe_encoder</code> åŸ·è¡Œæª”é€²è¡Œé–‹ç™¼èˆ‡é©—è­‰ã€‚</li><li>åˆ©ç”¨ <code>EncoderSink</code> åŠ print debug æŠ€è¡“åˆ†æ <code>AL_TEncSettings</code> æ­£ç¢ºå€¼ã€‚</li></ul></li></ul><hr><h2 id=-4-ä½¿ç”¨-exe_encoder-ä¸¦åˆ—å°-al_tencsettings2025-07-10>âœ… 4. ä½¿ç”¨ <code>exe_encoder</code> ä¸¦åˆ—å° <code>AL_TEncSettings</code>ï¼ˆ2025-07-10ï¼‰</h2><ul><li>æˆåŠŸåŸ·è¡Œ <code>exe_encoder</code>ï¼Œå®Œæˆæ¸¬è©¦ YUV ç·¨ç¢¼ã€‚</li><li>ä¿®æ”¹ encoder ä¸»ç¨‹å¼ï¼Œ<strong>å®Œæ•´å°å‡º <code>AL_TEncSettings</code> çµæ§‹æ‰€æœ‰æ¬„ä½</strong>ï¼Œä¾¿æ–¼å¾ŒçºŒç¨‹å¼æ¯”å°èˆ‡èª¿åƒã€‚</li></ul><hr><h2 id=-5-build-æ­£ç¢ºç‰ˆæœ¬çš„-vcu-control-swvcu-202512025-07-10>âœ… 5. Build æ­£ç¢ºç‰ˆæœ¬çš„ VCU Control SWï¼š<code>VCU 2025.1</code>ï¼ˆ2025-07-10ï¼‰</h2><ul><li><p><strong>é—œéµç™¼ç¾</strong>ï¼š</p><ul><li>é›–ç„¶ <code>VCU 2023.1</code> å¯ç·¨è­¯ï¼Œä½† encoder å¯¦éš›é‹è¡Œæœƒ crashã€‚</li><li>å¿…é ˆä½¿ç”¨ <code>VCU 2025.1</code>ï¼Œæ‰èƒ½ç©©å®šé€²è¡Œ encodingã€‚</li></ul></li><li><p><strong>ç·¨è­¯æ­¥é©Ÿ</strong>ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># è¨­å®š cross compile ç’°å¢ƒ</span>
</span></span><span style=display:flex><span>source ~/VEGA2200/trunk/xilinx_sdk_r5_vega6000/sdk/environment-setup-cortexa72-cortexa53-xilinx-linux
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># é€²å…¥æ­£ç¢ºç‰ˆæœ¬çš„ source tree</span>
</span></span><span style=display:flex><span>cd ~/vcu-ctrl-sw-xlnx_rel_v2025.1
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># ç·¨è­¯</span>
</span></span><span style=display:flex><span>make -j8
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># ç¢ºèªè¼¸å‡ºæª”æ¡ˆå‹æ…‹</span>
</span></span><span style=display:flex><span>file bin/AL_Encoder.exe
</span></span></code></pre></div></li><li><p><strong>æˆæœ</strong>ï¼š</p><ul><li>æˆåŠŸç”¢å‡º <code>AL_Encoder.exe</code>ï¼Œå¯æ–¼ ZCU106 æ­£å¸¸é‹è¡Œã€‚</li><li>è¼¸å‡º YUV encode çµæœæ­£ç¢ºï¼Œbitrate ç¬¦åˆé æœŸï¼Œè­‰å¯¦ encoder pipeline å¯ç”¨ã€‚</li></ul></li></ul><hr></section><div class=post-tags><nav class="nav tags"><ul class=tags><li><a href=/tags/vcu>VCU</a></li></ul></nav></div></div></div></article></main><footer><div style=display:flex></div><div class=footer-info>2025 <a href=https://github.com/athul/archie>Archie Theme</a> | Built with <a href=https://gohugo.io>Hugo</a></div></footer></div></body></html>